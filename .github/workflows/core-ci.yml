name: core-ci

on:
  push:
  pull_request:

jobs:
  build-and-smoke:
    runs-on: windows-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      - name: Build Debug
        run: msbuild D-Engine.sln /p:Configuration=Debug /p:Platform=x64 /m

      - name: Build Release
        run: msbuild D-Engine.sln /p:Configuration=Release /p:Platform=x64 /m

      - name: Build Debug (mem tracking compile-only)
        run: >
          msbuild D-Engine.vcxproj
          /p:Configuration=Debug
          /p:Platform=x64
          /p:PreprocessorDefinitions="DNG_MEM_TRACKING=1;DNG_MEM_CAPTURE_CALLSITE=1;%(PreprocessorDefinitions)"
          /p:BuildProjectReferences=false

      - name: Run AllSmokes
        shell: pwsh
        run: |
          $candidates = Get-ChildItem -Path . -Recurse -Filter 'AllSmokes*.exe' | Sort-Object @{Expression = { $_.FullName -match 'Release' } ; Descending = $true}, FullName
          if (-not $candidates) {
            Write-Error 'AllSmokes executable not found after build.'
            exit 1
          }
          $exe = $candidates[0].FullName
          Write-Host "Running" $exe
          & $exe
          if ($LASTEXITCODE -ne 0) {
            Write-Error "AllSmokes failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

      - name: Run ModuleSmoke (ABI runtime smoke)
        shell: pwsh
        run: |
          $candidates = Get-ChildItem -Path . -Recurse -Filter 'ModuleSmoke*.exe' | Sort-Object @{Expression = { $_.FullName -match 'Release' } ; Descending = $true}, FullName
          if (-not $candidates) {
            Write-Error 'ModuleSmoke executable not found after build.'
            exit 1
          }
          $exe = $candidates[0].FullName
          Write-Host "Running" $exe
          & $exe
          if ($LASTEXITCODE -ne 0) {
            Write-Error "ModuleSmoke failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
